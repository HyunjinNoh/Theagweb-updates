name: Deploy to EC2

# ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤í–‰ë  ì¡°ê±´ ì„¤ì •
on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch: # ìˆ˜ë™ ë°°í¬ íŠ¸ë¦¬ê±° (GitHub UIì—ì„œ ì‹¤í–‰ ê°€ëŠ¥)

# í™˜ê²½ë³€ìˆ˜ ì„¤ì • (ì „ì²´ ì›Œí¬í”Œë¡œìš°ì—ì„œ ì‚¬ìš©)
env:
  NODE_VERSION: "20"
  FRONTEND_DIR: "frontend"
  BACKEND_DIR: "backend"

jobs:
  # ë°°í¬ ì‘ì—… ì •ì˜
  deploy:
    runs-on: ubuntu-latest # GitHub ì œê³µ Ubuntu ëŸ¬ë„ˆ ì‚¬ìš©

    steps:
      # 1. ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4 # GitHub ì €ì¥ì†Œì˜ ì½”ë“œë¥¼ ëŸ¬ë„ˆì— ë‹¤ìš´ë¡œë“œ

      # 2. Node.js í™˜ê²½ ì„¤ì •
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }} # í™˜ê²½ë³€ìˆ˜ì—ì„œ ë²„ì „ ì°¸ì¡°
          cache: "npm" # npm ìºì‹œ í™œì„±í™”ë¡œ ë¹Œë“œ ì†ë„ í–¥ìƒ
          cache-dependency-path: | # ìºì‹œí•  package-lock.json íŒŒì¼ë“¤ ì§€ì •
            ${{ env.FRONTEND_DIR }}/package-lock.json
            ${{ env.BACKEND_DIR }}/package-lock.json

      # 3. ì˜ì¡´ì„± ê²€ì¦ (ë¹ ë¥¸ ì²´í¬)
      - name: ğŸ” Verify dependencies
        run: |
          cd ${{ env.BACKEND_DIR }}  
          npm ci --dry-run  
          cd ../${{ env.FRONTEND_DIR }}  
          npm ci --dry-run

      # 4. EC2ì— ë°°í¬ ì‹¤í–‰
      - name: ğŸš€ Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_PUBLIC_IP }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            # ì—ëŸ¬ ë°œìƒ ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨
            set -e  

            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            PROJECT_DIR="/home/ec2-user/Theagweb-updates"
            cd $PROJECT_DIR

            echo "ğŸ“¥ Pulling latest code..."
            git pull origin main

            echo "ğŸ”§ Installing backend dependencies..."
            cd backend
            npm ci 

            echo "ğŸ”§ Installing frontend dependencies..."
            cd ../frontend
            npm ci

            echo "ğŸ”¨ Building frontend..."  
            npm run build  

            echo "ğŸ“‹ Copying build files to nginx serving folder..."
            sudo cp -r build/* /var/www/html/

            echo "ğŸ”ƒ Restart Server..."
            cd ../backend
            pm2 restart server.js
            sudo systemctl restart nginx

      # 5. ë°°í¬ ìƒíƒœ í™•ì¸
      - name: ğŸ” Health check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_PUBLIC_IP }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            echo "ğŸ” Checking service status..."

            # PM2 ìƒíƒœ í™•ì¸
            pm2 status

            # ì›¹ì‚¬ì´íŠ¸ ì ‘ê·¼ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
            curl -f http://theajouglobe.kr > /dev/null && echo "âœ… Website is accessible" || echo "âŒ Website check failed"

      # 6. ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      - name: ğŸ“¢ Deployment notification
        if: always() # ì„±ê³µ/ì‹¤íŒ¨ ê´€ê³„ì—†ì´ í•­ìƒ ì‹¤í–‰
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ Deployment to EC2 completed successfully!"
            echo "ğŸ“… Deployed at: $(date)"
            echo "ğŸ”— Commit: ${{ github.sha }}"
          else
            echo "âŒ Deployment failed!"
            echo "ğŸ” Please check the logs above for details."
          fi
