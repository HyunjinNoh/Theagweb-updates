name: Deploy to EC2

# ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤í–‰ë  ì¡°ê±´ ì„¤ì •
on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch: # ìˆ˜ë™ ë°°í¬ íŠ¸ë¦¬ê±° (GitHub UIì—ì„œ ì‹¤í–‰ ê°€ëŠ¥)

# í™˜ê²½ë³€ìˆ˜ ì„¤ì • (ì „ì²´ ì›Œí¬í”Œë¡œìš°ì—ì„œ ì‚¬ìš©)
env:
  NODE_VERSION: "20"
  FRONTEND_DIR: "frontend"
  BACKEND_DIR: "backend"

jobs:
  # ë°°í¬ ì‘ì—… ì •ì˜
  deploy:
    runs-on: ubuntu-latest # GitHub ì œê³µ Ubuntu ëŸ¬ë„ˆ ì‚¬ìš©
    timeout-minutes: 10

    steps:
      # 1. ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4 # GitHub ì €ì¥ì†Œì˜ ì½”ë“œë¥¼ ëŸ¬ë„ˆì— ë‹¤ìš´ë¡œë“œ

      # 2. Node.js í™˜ê²½ ì„¤ì •
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }} # í™˜ê²½ë³€ìˆ˜ì—ì„œ ë²„ì „ ì°¸ì¡°
          cache: "npm"
          cache-dependency-path: | # ìºì‹œí•  package-lock.json íŒŒì¼ë“¤ ì§€ì •
            ${{ env.FRONTEND_DIR }}/package-lock.json
            ${{ env.BACKEND_DIR }}/package-lock.json

      # 3. ì˜ì¡´ì„± ê²€ì¦ (ë¹ ë¥¸ ì²´í¬)
      - name: ğŸ” Verify dependencies
        run: |
          cd ${{ env.BACKEND_DIR }}  
          npm ci --dry-run  
          cd ../${{ env.FRONTEND_DIR }}  
          npm ci --dry-run

      # 4. EC2ì— ë°°í¬ ì‹¤í–‰
      - name: ğŸš€ Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_PUBLIC_IP }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 480s
          script: |
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            PROJECT_DIR="/home/ec2-user/Theagweb-updates"
            cd $PROJECT_DIR

            echo "ğŸ“¥ Pulling latest code..."
            git pull origin main

            echo "ğŸ”§ Installing backend dependencies..."
            cd backend
            npm install # ì•ˆì „í•˜ê²Œ ì¼ë‹¨ ci ëŒ€ì‹  install

            echo "ğŸ”§ Installing frontend dependencies..."
            cd ../frontend
            npm install # ì•ˆì „í•˜ê²Œ ì¼ë‹¨ ci ëŒ€ì‹  install

            echo "ğŸ”¨ Building frontend..."  
            npm run build  

            echo "ğŸ“‹ Copying build files to nginx serving folder..."
            sudo cp -r build/* /var/www/html/

            echo "ğŸ”ƒ Restart Server..."
            cd ../backend
            pm2 restart server.js
            sudo systemctl restart nginx

      # 5. ë°°í¬ ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
      - name: ğŸ”„ Rollback on failure
        if: failure() # ì´ì „ ë‹¨ê³„ê°€ ì‹¤íŒ¨í–ˆì„ ë•Œë§Œ ì‹¤í–‰
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_PUBLIC_IP }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            echo "âŒ Deployment failed, starting rollback..."

            PROJECT_DIR="/home/ec2-user/Theagweb-updates"
            cd $PROJECT_DIR

            # Gitìœ¼ë¡œ ì´ì „ ì»¤ë°‹ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°
            echo "ğŸ”„ Rolling back to previous commit..."
            git reset --hard HEAD~1

            # ë°±ì—”ë“œ ì˜ì¡´ì„± ì¬ì„¤ì¹˜
            echo "ğŸ”§ Reinstalling backend dependencies..."
            cd backend
            npm install

            # í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„± ì¬ì„¤ì¹˜ ë° ë¹Œë“œ
            echo "ğŸ”§ Reinstalling frontend dependencies and rebuilding..."
            cd ../frontend
            npm install
            npm run build

            # nginx í´ë”ì— ë¹Œë“œ íŒŒì¼ ë³µì‚¬
            echo "ğŸ“‹ Copying rollback build files..."
            sudo cp -r build/* /var/www/html/

            # ì„œë²„ ì¬ì‹œì‘
            echo "ğŸ”ƒ Restarting services after rollback..."
            cd ../backend
            pm2 restart server.js
            sudo systemctl restart nginx

            echo "âœ… Rollback completed"
